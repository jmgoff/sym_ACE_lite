from equivariant_calc.chem_B import *
from scipy.spatial.transform import Rotation as R

from ase.build import bulk

import json

from ase import Atoms,Atom
from ase.io import read,write

import numpy as np
#-----------------------------------------------------------
# INPUT
#-----------------------------------------------------------
ranks = [1,2,3,4]                    # ranks of basis functions to be evaluated
rc = 5.                          # radial cutoff (angstroms) for radial basis
lmbda=2.0                         # exponential factor for sampling of r << r_c in g_k(r)
#lmbda=0.005                         # exponential factor for sampling of r << r_c in g_k(r)
nradbase=2                       # maximum k in g_k expansion of R_nl (expansion representation of radial basis not implemented yet)
lmax_dict =    {1:0,        2: 2, 3:2, 4:2}
nradmax_dict = {1:nradbase, 2: 2, 3:2, 4:2}

elements = ['H','O']

import sys

infiles = ['latte_cell_40.xyz', 'latte_cell_50.xyz', 'latte_cell_60.xyz']
infile = sys.argv[1]
i_d = infiles.index(infile)
atoms = read(infile)

L_R = 0
M_R= 0

# example for generating couplings used to reduce spherical harmonics
from clebsch_couple import *
try:
    with open('cg_LR_0_r1234_lmax0222.pickle','rb') as handle:
        ccs = pickle.load(handle)
except FileNotFoundError:
    ccs = get_cg_coupling(lmax_dict,L_R=L_R)
    print (ccs)
    #store them for later so they don't need to be recalculated
    store_generalized(ccs, coupling_type='cg',L_R=L_R)

orb_nls_rank1 = ['0_0,2,0_', '0_1,1,0_', '0_1,2,0_', '1_1,1,0_', '1_0,1,0_', '1_1,2,0_', '1_0,2,0_', '0_0,1,0_']

orb_nls_rank2 = ['1_1,1,1,1,2,2_', '0_0,1,1,2,2,2_', '0_0,0,1,2,2,2_', '0_1,1,1,2,1,1_', '0_1,1,2,2,1,1_', '0_0,0,1,2,0,0_', '0_0,0,1,1,1,1_', '1_0,0,1,1,2,2_', '0_0,0,2,2,1,1_', '1_0,1,1,2,1,1_', '0_0,0,2,2,0,0_', '1_0,1,1,1,2,2_', '1_1,1,2,2,1,1_', '0_0,1,1,1,1,1_', '1_0,0,1,2,1,1_', '0_1,1,1,1,1,1_', '1_1,1,1,2,0,0_', '0_0,1,2,2,0,0_', '0_0,1,1,2,1,1_', '0_0,1,2,2,1,1_', '0_1,1,2,2,0,0_', '1_0,1,2,1,0,0_', '0_1,1,1,2,2,2_', '0_1,1,2,2,2,2_', '0_0,1,1,1,2,2_', '1_0,0,2,2,1,1_', '0_0,1,2,1,2,2_', '1_0,1,2,2,1,1_', '0_1,1,1,1,0,0_', '1_1,1,1,1,1,1_', '0_0,1,2,2,2,2_', '0_0,1,1,1,0,0_', '1_0,1,1,2,0,0_', '1_0,1,1,1,1,1_', '1_1,1,2,2,2,2_', '1_1,1,1,1,0,0_', '0_0,0,1,2,1,1_', '1_0,0,1,1,0,0_', '0_0,1,2,1,0,0_', '1_0,1,1,2,2,2_', '0_1,1,1,1,2,2_', '1_0,0,2,2,0,0_', '1_0,0,1,2,2,2_', '1_0,1,2,1,1,1_', '0_0,0,1,1,0,0_', '1_0,1,2,2,2,2_', '1_1,1,1,2,2,2_', '0_1,1,1,2,0,0_', '0_0,0,1,1,2,2_', '1_1,1,2,2,0,0_', '0_0,1,2,1,1,1_', '1_0,0,1,1,1,1_', '1_0,0,1,2,0,0_', '0_0,0,2,2,2,2_', '1_0,0,2,2,2,2_', '1_1,1,1,2,1,1_', '1_0,1,1,1,0,0_', '1_0,1,2,1,2,2_', '0_0,1,1,2,0,0_', '1_0,1,2,2,0,0_']

orb_nls_rank3 = ['0_1,1,1,2,1,1,0,1,1_1', '1_0,1,1,2,2,2,2,2,2_2', '1_1,1,1,1,1,2,0,1,1_1', '0_0,1,1,1,1,1,1,1,2_2', '1_0,0,1,1,1,2,0,2,2_2', '1_0,0,1,1,2,2,1,1,2_2', '1_0,1,1,1,1,1,0,2,2_2', '0_0,0,1,2,2,2,2,2,2_2', '1_0,1,1,1,2,2,0,1,1_1', '1_0,0,0,2,2,2,0,0,0_0', '0_0,0,1,1,2,2,0,1,1_1', '0_0,0,0,1,1,1,2,2,2_2', '0_0,0,0,1,1,2,0,2,2_2', '1_0,0,1,2,1,1,0,2,2_2', '1_0,0,1,2,2,2,0,2,2_2', '0_0,1,1,2,1,2,2,2,2_2', '0_0,0,0,1,1,1,1,1,2_2', '0_0,0,1,1,1,2,2,2,2_2', '0_0,0,1,1,2,2,2,2,2_2', '0_0,1,1,1,2,2,2,2,2_2', '1_0,1,1,1,1,1,1,1,2_2', '0_1,1,1,2,2,2,0,1,1_1', '1_0,1,1,1,1,2,0,1,1_1', '1_0,0,1,2,1,2,0,2,2_2', '1_0,0,1,1,2,2,0,2,2_2', '0_0,1,1,2,1,1,0,2,2_2', '1_0,0,0,1,1,2,0,2,2_2', '0_1,1,1,2,2,2,0,0,0_0', '1_0,0,1,1,1,2,0,0,0_0', '1_0,0,1,2,2,1,1,1,2_2', '0_0,1,1,2,1,1,0,1,1_1', '1_0,0,1,1,1,2,0,1,1_1', '0_0,0,1,1,2,1,0,0,0_0', '1_0,0,1,2,2,2,0,1,1_1', '0_0,0,1,1,2,2,1,1,2_2', '1_0,1,1,2,1,1,0,2,2_2', '0_1,1,1,1,2,2,1,1,2_2', '1_0,0,0,1,2,2,0,1,1_1', '1_0,0,1,2,2,2,1,1,2_2', '0_0,1,1,2,1,2,0,1,1_1', '1_0,0,0,2,1,1,0,1,1_1', '1_0,0,1,1,2,1,2,2,2_2', '1_0,1,1,1,1,1,2,2,2_2', '0_0,1,1,1,1,1,0,1,1_1', '0_0,0,0,1,2,1,1,1,2_2', '0_0,0,0,2,2,2,0,0,0_0', '0_0,0,1,1,2,1,1,1,2_2', '0_0,1,1,1,1,2,2,2,2_2', '1_0,0,0,1,2,2,0,0,0_0', '0_0,1,1,1,2,2,0,2,2_2', '1_0,0,0,1,1,1,1,1,2_2', '0_0,0,0,2,1,2,0,2,2_2', '0_1,1,1,1,1,1,2,2,2_2', '0_0,0,1,1,1,1,1,1,2_2', '0_0,0,1,1,1,2,0,0,0_0', '1_0,0,1,2,2,2,2,2,2_2', '0_0,0,1,2,2,1,0,2,2_2', '0_0,0,1,2,2,2,1,1,2_2', '0_1,1,1,2,2,2,1,1,2_2', '0_0,1,1,2,2,1,1,1,2_2', '0_0,1,1,1,2,1,1,1,2_2', '1_0,1,1,2,1,1,0,1,1_1', '0_0,0,0,1,2,2,0,2,2_2', '0_0,0,0,1,1,1,0,0,0_0', '0_0,0,0,2,2,2,0,2,2_2', '1_0,1,1,2,1,2,0,2,2_2', '0_0,0,0,2,2,2,1,1,2_2', '0_0,1,1,2,1,2,0,2,2_2', '0_1,1,1,1,2,2,0,1,1_1', '1_1,1,1,1,2,1,1,1,2_2', '0_1,1,1,2,2,1,1,1,2_2', '1_1,1,1,2,2,2,0,1,1_1', '0_0,0,1,2,1,1,0,2,2_2', '0_0,0,1,1,1,1,0,1,1_1', '1_0,0,1,1,2,2,2,2,2_2', '1_0,1,1,2,2,2,1,1,2_2', '0_0,0,1,2,2,1,0,0,0_0', '0_0,0,1,2,1,1,0,1,1_1', '0_0,1,1,1,1,1,0,0,0_0', '0_0,0,1,2,2,1,2,2,2_2', '1_0,0,1,1,2,1,0,2,2_2', '0_0,1,1,1,1,2,1,1,2_2', '0_1,1,1,2,2,2,0,2,2_2', '1_1,1,1,2,2,1,1,1,2_2', '1_0,0,1,2,2,1,0,2,2_2', '1_0,1,1,1,1,1,0,0,0_0', '0_1,1,1,1,1,1,0,2,2_2', '1_0,0,0,1,1,2,0,0,0_0', '1_1,1,1,2,2,2,0,2,2_2', '1_0,1,1,2,1,1,1,1,2_2', '1_0,0,0,1,2,2,2,2,2_2', '1_0,1,1,1,1,2,0,0,0_0', '1_1,1,1,1,1,1,0,0,0_0', '0_0,1,1,1,1,2,0,0,0_0', '1_0,1,1,2,1,1,0,0,0_0', '1_0,0,0,1,2,1,1,1,2_2', '0_0,0,0,1,1,2,1,1,2_2', '0_0,0,0,2,2,2,0,1,1_1', '0_0,0,1,1,1,1,0,2,2_2', '0_0,0,1,1,1,1,2,2,2_2', '0_1,1,1,1,1,2,0,2,2_2', '1_0,1,1,1,1,2,1,1,2_2', '1_0,0,1,1,2,1,0,1,1_1', '1_0,0,1,1,1,1,0,2,2_2', '1_0,0,0,2,2,1,1,1,2_2', '1_1,1,1,1,1,2,1,1,2_2', '1_1,1,1,1,2,2,0,0,0_0', '0_0,0,1,1,1,1,0,0,0_0', '1_1,1,1,1,2,2,2,2,2_2', '0_0,0,0,2,1,1,0,2,2_2', '1_0,0,1,2,2,2,0,0,0_0', '1_0,0,1,1,2,2,0,1,1_1', '1_1,1,1,1,2,2,0,2,2_2', '0_0,1,1,1,1,1,2,2,2_2', '1_0,0,0,1,1,1,2,2,2_2', '0_0,0,1,2,1,2,0,1,1_1', '1_0,0,0,2,1,1,0,2,2_2', '0_0,0,1,1,1,2,0,1,1_1', '1_1,1,1,2,2,2,0,0,0_0', '0_1,1,1,1,2,2,0,2,2_2', '0_1,1,1,1,2,2,0,0,0_0', '0_1,1,1,1,1,1,0,0,0_0', '0_0,0,1,1,1,2,0,2,2_2', '0_0,0,1,2,2,2,0,2,2_2', '1_1,1,1,1,1,1,0,1,1_1', '0_1,1,1,1,2,1,1,1,2_2', '0_0,0,0,1,1,2,2,2,2_2', '0_0,1,1,2,1,2,0,0,0_0', '0_0,0,1,2,2,2,0,1,1_1', '0_0,1,1,1,2,2,0,1,1_1', '1_1,1,1,2,1,2,0,2,2_2', '1_1,1,1,1,1,1,1,1,2_2', '0_0,0,0,1,1,1,0,1,1_1', '1_1,1,1,1,1,2,0,0,0_0', '0_0,0,1,2,1,2,0,2,2_2', '1_0,0,1,1,2,2,0,0,0_0', '1_0,0,1,2,2,1,0,0,0_0', '1_1,1,1,2,1,2,0,1,1_1', '1_0,0,0,2,1,2,0,1,1_1', '0_0,0,1,1,2,1,0,1,1_1', '1_0,0,0,2,2,2,1,1,2_2', '1_0,1,1,2,1,2,1,1,2_2', '1_0,1,1,2,1,2,0,1,1_1', '1_0,0,1,1,1,1,0,0,0_0', '1_0,1,1,1,2,2,1,1,2_2', '1_0,1,1,1,2,2,0,2,2_2', '1_0,0,0,1,1,2,1,1,2_2', '0_0,0,0,1,2,2,0,1,1_1', '1_1,1,1,1,1,1,2,2,2_2', '0_0,1,1,2,2,2,2,2,2_2', '0_1,1,1,2,1,1,0,2,2_2', '1_0,0,0,2,2,2,0,2,2_2', '1_1,1,1,1,1,2,0,2,2_2', '0_0,0,0,1,1,1,0,2,2_2', '0_0,1,1,1,2,2,1,1,2_2', '0_0,0,0,1,2,2,0,0,0_0', '1_0,0,0,1,1,2,0,1,1_1', '1_1,1,1,2,1,1,0,2,2_2', '1_0,0,0,1,1,2,2,2,2_2', '0_0,0,1,1,2,2,0,2,2_2', '0_0,0,1,1,1,2,1,1,2_2', '0_1,1,1,1,1,1,0,1,1_1', '1_0,1,1,1,2,1,1,1,2_2', '0_0,0,0,1,2,2,2,2,2_2', '1_0,0,1,2,2,1,2,2,2_2', '1_1,1,1,1,1,1,0,2,2_2', '0_0,1,1,2,1,1,0,0,0_0', '1_0,1,1,2,2,2,0,0,0_0', '0_1,1,1,1,1,2,1,1,2_2', '0_1,1,1,1,1,2,0,0,0_0', '1_0,0,0,1,1,1,0,2,2_2', '0_0,0,0,2,1,2,0,1,1_1', '1_0,0,1,1,1,1,1,1,2_2', '1_0,0,0,1,2,2,1,1,2_2', '1_0,1,1,1,1,2,0,2,2_2', '1_0,1,1,2,2,1,1,1,2_2', '1_0,0,1,1,1,2,1,1,2_2', '0_1,1,1,1,1,2,2,2,2_2', '0_1,1,1,2,2,2,2,2,2_2', '1_0,0,1,1,1,1,2,2,2_2', '1_0,1,1,2,2,2,0,2,2_2', '0_0,0,0,1,1,2,0,1,1_1', '0_0,1,1,1,1,1,0,2,2_2', '1_0,1,1,1,2,2,2,2,2_2', '1_0,0,0,2,2,2,0,1,1_1', '0_0,0,1,2,2,1,0,1,1_1', '0_1,1,1,1,1,2,0,1,1_1', '1_0,1,1,2,1,1,2,2,2_2', '0_0,1,1,2,2,2,0,1,1_1', '1_1,1,1,2,2,2,1,1,2_2', '1_1,1,1,2,2,2,2,2,2_2', '1_1,1,1,1,2,2,1,1,2_2', '0_0,0,1,1,2,2,0,0,0_0', '1_0,1,1,2,1,2,0,0,0_0', '0_0,0,0,1,2,2,1,1,2_2', '0_0,1,1,2,2,2,0,2,2_2', '1_0,0,1,1,1,1,0,1,1_1', '1_0,0,1,2,1,1,0,1,1_1', '0_0,0,0,2,2,1,1,1,2_2', '1_0,0,0,1,1,1,0,0,0_0', '1_0,0,1,2,1,2,0,1,1_1', '0_0,1,1,2,2,2,0,0,0_0', '0_1,1,1,1,2,2,2,2,2_2', '0_0,1,1,2,1,2,1,1,2_2', '0_0,0,0,2,2,2,2,2,2_2', '0_0,1,1,2,2,2,1,1,2_2', '0_1,1,1,2,1,2,0,1,1_1', '0_0,0,1,1,2,1,2,2,2_2', '0_0,0,1,2,2,2,0,0,0_0', '1_1,1,1,1,1,2,2,2,2_2', '0_0,1,1,1,2,2,0,0,0_0', '0_0,1,1,2,1,1,1,1,2_2', '1_0,0,1,1,2,1,1,1,2_2', '0_1,1,1,1,1,1,1,1,2_2', '1_0,1,1,2,2,2,0,1,1_1', '1_0,0,1,1,2,1,0,0,0_0', '0_0,0,1,2,2,1,1,1,2_2', '0_0,0,0,1,1,2,0,0,0_0', '1_0,1,1,2,1,2,2,2,2_2', '1_0,1,1,1,2,2,0,0,0_0', '1_0,0,0,1,2,2,0,2,2_2', '1_1,1,1,2,1,1,0,1,1_1', '1_1,1,1,1,2,2,0,1,1_1', '0_0,0,0,2,1,1,0,1,1_1', '1_0,0,0,2,2,2,2,2,2_2', '1_0,0,0,1,1,1,0,1,1_1', '0_1,1,1,2,1,2,0,2,2_2', '1_0,1,1,1,1,2,2,2,2_2', '1_0,0,1,1,1,2,2,2,2_2', '0_0,1,1,1,1,2,0,1,1_1', '0_0,1,1,1,1,2,0,2,2_2', '1_0,1,1,1,1,1,0,1,1_1', '0_0,0,1,1,2,1,0,2,2_2', '0_0,1,1,2,1,1,2,2,2_2', '1_0,0,0,2,1,2,0,2,2_2', '1_0,0,1,2,2,1,0,1,1_1']

orb_nls_rank4 = ['0_0,0,0,0,1,1,2,2,1,1,2,2_0-0', '0_0,0,0,0,1,2,1,2,1,1,2,2_0-0', '0_0,0,0,0,2,2,1,1,1,1,2,2_0-0', '0_0,0,0,0,1,1,2,2,1,1,2,2_2-2', '0_0,0,0,0,2,2,1,1,1,1,2,2_2-2', '0_0,0,0,0,1,1,2,2,1,2,1,2_1-1', '0_0,0,0,0,1,1,2,2,1,2,1,2_3-3',
'1_0,0,0,0,1,1,2,2,1,1,2,2_0-0', '1_0,0,0,0,1,2,1,2,1,1,2,2_0-0', '1_0,0,0,0,2,2,1,1,1,1,2,2_0-0', '1_0,0,0,0,1,1,2,2,1,1,2,2_2-2', '1_0,0,0,0,2,2,1,1,1,1,2,2_2-2', '1_0,0,0,0,1,1,2,2,1,2,1,2_1-1', '1_0,0,0,0,1,1,2,2,1,2,1,2_3-3'
]

orb_nls = orb_nls_rank1 + orb_nls_rank2 + orb_nls_rank3 + orb_nls_rank4

descriptor_type = 'chemical_radial_angular'
nus = orb_nls
#mu0,mu,n,l,inter = get_mu_n_l(orb_nl,return_L=True)
arg = {'id':i_d,'atoms':atoms,'elements':elements,'rc':rc,'nradbase':nradbase,'nradmax':nradmax_dict,'lmax':lmax_dict,'lmbda':lmbda,'rank':ranks,'nus':nus,'ccs':ccs, 'descriptor_type':descriptor_type, 'L_R':0, 'M_R':0}
B_per_atom = atoms_eB(arg)
ats = list(B_per_atom.keys())
print (B_per_atom)
with open('b_per_atom_%d.json' % i_d,'w') as writejson:
    json.dump(B_per_atom,writejson, sort_keys=False, indent=2)

